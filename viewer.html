<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚ù§Ô∏è Sorpresa de Hoy</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sacramento&family=Indie+Flower&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>
  <div class="bg-decoration">
    <div class="cloud"></div><div class="cloud"></div><div class="cloud"></div><div class="cloud"></div>
  </div>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="title">‚ù§Ô∏è <span class="title-script">Sorpresa de Hoy</span></div>
        <div class="subtitle">Ver√°s notas distintas todos los d√≠as. Siempre a la misma hora. Solo para mi ni√±a linda ‚ù§Ô∏è</div>
      </div>
      <div class="btns">
        <button class="ghost pill danger" id="resetBtn" title="Limpiar datos guardados si es necesario">
          Restablecer
        </button>
      </div>
    </header>

    <section class="card">
      <div class="today" id="todayBox">
        <div class="tz-badge" id="tzBadge">‚Äî</div>
        <div id="todayState" class="hint">Cargando‚Ä¶</div>

        <!-- View 1: Countdown -->
        <div class="countdown-container" id="countdown-view">
          <div class="countdown" id="revealTimeDisplay">Revelaci√≥n ‚Äî</div>
        </div>

        <!-- View 2: Envelope (Ready to Open) -->
        <div id="envelope-view" class="envelope-view" style="display:none;">
           <div class="envelope-wrapper" id="envelopeWrapper">
              <div class="envelope">
                <div class="flap"></div>
                <div class="pocket"></div>
                <div class="letter-preview"></div>
                <div class="seal">‚ù§Ô∏è</div>
              </div>
           </div>
           <div class="click-hint">¬°Tienes una nota nueva! Haz clic para abrir.</div>
        </div>

        <!-- View 3: Revealed Note -->
        <div id="note-view" class="note-view" style="display:none;">
            <div class="note-paper">
                <div id="noteText"></div>
            </div>

            <div class="reactions">
                <button class="reaction-btn" title="Me encanta" data-emoji="ü•∞">ü•∞</button>
                <button class="reaction-btn" title="Abrazo" data-emoji="ü§ó">ü§ó</button>
                <button class="reaction-btn" title="Beso" data-emoji="üòò">üòò</button>
                <button class="reaction-btn" title="Te extra√±o" data-emoji="ü•∫">ü•∫</button>
            </div>
        </div>

        <div class="confetti" id="confetti"></div>
      </div>
      <div class="footer" style="text-align: center; margin-top: 16px; color: var(--muted); font-size: 14px;">
        Ojitos lindos y esa sonrisa hermosa. 
      </div>
    </section>
  </div>

  <script>
    const { DateTime } = luxon;
    const STORAGE_KEY = 'surpriseScheduler_v2'; // Match with v2

    // DOM
    const els = {
      tzBadge: document.getElementById('tzBadge'),
      todayState: document.getElementById('todayState'),
      countdownView: document.getElementById('countdown-view'),
      revealTimeDisplay: document.getElementById('revealTimeDisplay'),

      envelopeView: document.getElementById('envelope-view'),
      envelopeWrapper: document.getElementById('envelopeWrapper'),
      envelopeDiv: document.querySelector('.envelope'),

      noteView: document.getElementById('note-view'),
      noteText: document.getElementById('noteText'),

      resetBtn: document.getElementById('resetBtn'),
      confetti: document.getElementById('confetti'),
      reactionBtns: document.querySelectorAll('.reaction-btn'),
    };

    // Storage helpers
    const save = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    const load = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch { return null; } };

    // View Switching
    function switchView(viewName) {
      els.countdownView.style.display = 'none';
      els.envelopeView.style.display = 'none';
      els.noteView.style.display = 'none';

      if(viewName === 'countdown') els.countdownView.style.display = 'flex';
      if(viewName === 'envelope') els.envelopeView.style.display = 'flex';
      if(viewName === 'note') els.noteView.style.display = 'flex';
    }

    function showCountdown(s){
      switchView('countdown');
      const now = DateTime.now().setZone(s.settings.partnerTZ);
      const todayTarget = now.set({hour:s.settings.revealHour, minute:s.settings.revealMinute, second:0, millisecond:0});
      const target = (now > todayTarget) ? todayTarget.plus({days:1}) : todayTarget;
      const diff = target.diff(now, ['hours','minutes','seconds']).toObject();
      els.todayState.textContent = `Pr√≥xima carta para ${s.settings.partnerName || 'ti'} a las ${target.toFormat('HH:mm')}`;

      const hh = String(Math.floor(diff.hours||0)).padStart(2,'0');
      const mm = String(Math.floor(diff.minutes||0)).padStart(2,'0');
      const ss = String(Math.floor(diff.seconds||0)).padStart(2,'0');
      els.revealTimeDisplay.textContent = `${hh}:${mm}:${ss}`;
    }

    function showEnvelope(entry, s) {
      // If already viewing envelope or note, skip unless force refresh?
      // Actually we should just set it.
      if (els.noteView.style.display === 'flex') return;

      switchView('envelope');
      els.todayState.textContent = `¬°Ha llegado una carta para ${s.settings.partnerName || 'ti'}!`;

      // Reset animations
      els.envelopeDiv.classList.remove('open');

      // Click handler
      els.envelopeWrapper.onclick = () => {
        els.envelopeDiv.classList.add('open');
        fireConfetti();

        // Mark revealed
        entry.revealed = true;
        entry.revealedAt = DateTime.now().setZone(s.settings.partnerTZ).toISO();
        save(s);

        setTimeout(() => {
           showNote(entry, s);
        }, 800);
      };
    }

    function showNote(entry, s){
      switchView('note');
      els.noteText.textContent = s.notes[entry.noteIndex];
      els.todayState.textContent = `Revelado ¬∑ ${DateTime.fromISO(entry.revealedAt).toFormat('HH:mm')}`;
    }

    // Logic
    function tickCountdown(){
      const s = load(); if(!s){ els.todayState.textContent = 'Esperando horario...'; return; }
      const now = DateTime.now().setZone(s.settings.partnerTZ);
      const today = now.startOf('day').toISODate();
      const entry = s.schedule.find(e => e.dateISO === today);
      els.tzBadge.textContent = s.settings.partnerTZ;

      if (!entry) {
        // Find next future entry?
        const future = s.schedule.find(e => DateTime.fromISO(e.dateISO, {zone:s.settings.partnerTZ}) > now);
        if(future) {
           els.todayState.textContent = `Pr√≥xima sorpresa: ${DateTime.fromISO(future.dateISO).toFormat('cccc d')}`;
           els.revealTimeDisplay.textContent = "Pronto...";
        } else {
           els.todayState.textContent = "¬°Todo completado!";
           els.revealTimeDisplay.textContent = "‚ù§Ô∏è";
        }
        return;
      }

      if (entry.revealed) {
        showNote(entry, s);
      } else {
        const revealTime = now.set({hour:s.settings.revealHour, minute:s.settings.revealMinute, second:0, millisecond:0});
        if (now >= revealTime) {
          showEnvelope(entry, s);
        } else {
          showCountdown(s);
        }
      }
    }

    // Auto-load schedule.json on first visit
    async function autoLoadScheduleFromJSON(){
      const existing = load(); if (existing) return;
      try {
        const res = await fetch('schedule.json?v=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) { els.todayState.textContent = 'Horario no encontrado.'; return; }
        const obj = await res.json();
        if (obj && obj.settings && obj.notes && obj.schedule) {
          save(obj);
          tickCountdown();
        }
      } catch { els.todayState.textContent = 'Error de conexi√≥n.'; }
    }

    // Confetti
    function fireConfetti(){
      const cont = els.confetti; cont.innerHTML = '';
      const colors = ['#ff6b9d','#c44569','#8e44ad','#a569bd','#ff7675'];
      for(let i=0;i<60;i++){
        const p = document.createElement('div'); p.className='p';
        p.style.left = Math.random()*100 + 'vw';
        const dur = 2 + Math.random()*2.5; p.style.animation = `fall ${dur}s linear forwards`;
        p.style.background = colors[i % colors.length];
        p.style.transform = `translateY(-30px) rotate(${Math.random()*360}deg)`;
        cont.appendChild(p);
      }
      setTimeout(()=>{ cont.innerHTML=''; }, 5000);
    }

    // Reactions
    els.reactionBtns.forEach(btn => {
      btn.addEventListener('click', () => {
         const emoji = btn.getAttribute('data-emoji');
         fireEmoji(emoji);
      });
    });

    function fireEmoji(emoji) {
      const cont = els.confetti;
      for(let i=0; i<10; i++) {
        const p = document.createElement('div');
        p.textContent = emoji;
        p.style.position = 'absolute';
        p.style.left = (50 + (Math.random()*20 - 10)) + '%';
        p.style.top = '50%';
        p.style.fontSize = (24 + Math.random()*20) + 'px';
        p.style.pointerEvents = 'none';
        p.style.animation = `floatEmoji 1.5s ease-out forwards`;
        const tx = (Math.random()*200 - 100) + 'px';
        const ty = (Math.random()*200 - 100) + 'px';
        p.style.setProperty('--tx', tx);
        p.style.setProperty('--ty', ty);
        cont.appendChild(p);
        setTimeout(()=>p.remove(), 1500);
      }
    }

    // Add dynamic styles for emojis
    const style = document.createElement('style');
    style.textContent = `
      @keyframes floatEmoji {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        20% { opacity: 1; }
        100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1.5); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    function resetAll(){
      if(!confirm('¬øRestablecer?')) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    els.resetBtn.addEventListener('click', resetAll);

    // Init
    autoLoadScheduleFromJSON().then(()=>{ tickCountdown(); });
    (function loop(){ tickCountdown(); setTimeout(loop, 1000); })();
  </script>
</body>
</html>