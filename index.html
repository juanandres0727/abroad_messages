<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Programador de Sorpresas</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Sacramento&family=Indie+Flower&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
  <!-- Luxon for robust timezone handling -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
</head>
<body>

  <!-- Floating Background Elements for Coziness -->
  <div class="bg-decoration">
    <div class="cloud"></div>
    <div class="cloud"></div>
    <div class="cloud"></div>
    <div class="cloud"></div>
  </div>

  <div class="container">
    <header>
      <div class="header-content">
        <div class="title">ðŸ’Œ <span class="title-script">Sorpresas para ella</span></div>
        <div class="subtitle">Escribe notas dulces con anticipaciÃ³n â†’ se revelarÃ¡n en los dÃ­as seleccionados en <span id="subTZ">su zona horaria</span>.</div>
      </div>
      <div class="header-actions">
        <div class="action-group">
          <button class="ghost pill" id="exportBtn">Exportar</button>
          <input type="file" id="importInput" accept="application/json" hidden>
          <button class="ghost pill" id="importBtn">Importar</button>
        </div>
        <div class="action-group">
          <button class="ghost pill" id="clearBtn" title="Reiniciar todo">Restablecer</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Settings + Notes + Schedule -->
      <section class="card">
        <h2>1) ConfiguraciÃ³n</h2>
        <div class="row">
          <div>
            <label>Su nombre</label>
            <input id="partnerName" placeholder="e.g., mi amor" />
          </div>
          <div>
            <label>Su zona horaria</label>
            <input id="partnerTZ" list="tzList" placeholder="e.g., Europe/Madrid" />
            <datalist id="tzList"></datalist>
            <div class="hint">Escribe "Europe/" o "America/" para buscar.</div>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Hora de revelaciÃ³n</label>
            <input id="revealTime" type="time" value="09:00" />
          </div>
          <div>
            <label>Fecha de inicio</label>
            <input id="startDate" type="date" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Â¿CuÃ¡ntos dÃ­as?</label>
            <input id="numDays" type="number" min="1" max="400" value="30" />
          </div>
          <div>
            <label>Frecuencia</label>
            <select id="frequency">
              <option value="daily">Todos los dÃ­as</option>
              <option value="weekdays">DÃ­as laborables (Lunâ€“Vie)</option>
              <option value="custom">DÃ­as personalizadosâ€¦</option>
            </select>
          </div>
        </div>
        <div id="customWeekdays" class="custom-days" style="display:none">
          <div class="weekday-options">
            <label class="weekday-option"><input type="checkbox" class="wd" value="1" checked> Lun</label>
            <label class="weekday-option"><input type="checkbox" class="wd" value="2" checked> Mar</label>
            <label class="weekday-option"><input type="checkbox" class="wd" value="3" checked> MiÃ©</label>
            <label class="weekday-option"><input type="checkbox" class="wd" value="4" checked> Jue</label>
            <label class="weekday-option"><input type="checkbox" class="wd" value="5" checked> Vie</label>
            <label class="weekday-option"><input type="checkbox" class="wd" value="6"> SÃ¡b</label>
            <label class="weekday-option"><input type="checkbox" class="wd" value="7"> Dom</label>
          </div>
        </div>

        <h2 style="margin-top:24px">2) Escribe tus notas</h2>
        <label>Una nota por lÃ­nea. Â¡SÃ© creativo y cariÃ±oso! âœ¨</label>
        <textarea id="notes" placeholder="Eres mi notificaciÃ³n favorita.
Te extraÃ±o un montÃ³n.
Contando los dÃ­as para verte.
Me haces muy feliz.
Espero que tengas un dÃ­a hermoso."></textarea>
        <div class="btns">
          <button class="primary" id="generateBtn">Generar Horario</button>
        </div>

        <h2 style="margin-top:24px">3) Horario</h2>
        <div id="scheduleWrap" class="schedule-container">
          <table id="scheduleTable" aria-label="Schedule table">
            <thead><tr><th>#</th><th>Fecha</th><th>Hora</th><th>Nota</th><th>Estado</th></tr></thead>
            <tbody id="schedBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Right: Today panel Hello -->
      <section class="card">
        <h2>Sorpresa de Hoy</h2>
        <div class="today" id="todayBox">
          <div class="tz-badge" id="tzBadge">â€”</div>

          <!-- View 1: Countdown -->
          <div id="countdown-view" class="countdown-view">
              <div id="todayState" class="hint">...</div>
              <div class="countdown" id="countdown">â€“:â€“:â€“</div>
              <div class="btns">
                <button class="ghost" id="checkNowBtn">Verificar ahora</button>
              </div>
          </div>

          <!-- View 2: Envelope (Ready to Open) -->
          <div id="envelope-view" class="envelope-view" style="display:none;">
             <div class="envelope-wrapper" id="envelopeWrapper">
                <div class="envelope">
                  <div class="flap"></div>
                  <div class="pocket"></div>
                  <div class="letter-preview"></div> <!-- Just a white visual inside -->
                  <div class="seal">ðŸ’Œ</div>
                </div>
             </div>
             <div class="click-hint">Â¡Tienes una nota nueva! Haz clic para abrir.</div>
          </div>

          <!-- View 3: Revealed Note -->
          <div id="note-view" class="note-view" style="display:none;">
             <div class="note-paper">
                <div id="noteText"></div>
             </div>

             <div class="reactions">
                <button class="reaction-btn" title="Me encanta" data-emoji="ðŸ¥°">ðŸ¥°</button>
                <button class="reaction-btn" title="Abrazo" data-emoji="ðŸ¤—">ðŸ¤—</button>
                <button class="reaction-btn" title="Beso" data-emoji="ðŸ˜˜">ðŸ˜˜</button>
                <button class="reaction-btn" title="Te extraÃ±o" data-emoji="ðŸ¥º">ðŸ¥º</button>
             </div>

             <div class="btns" style="margin-top:12px">
                <button class="ghost" id="copyBtn">Copiar</button>
             </div>
          </div>

          <!-- Admin Override Button (Always accessible if needed, or hide it) -->
          <div style="margin-top:20px; opacity:0.3;">
             <button class="ghost pill" style="font-size:10px; padding:4px 8px;" id="revealNowBtn">Debug: Revelar Ahora</button>
          </div>

          <!-- Effects -->
          <div class="confetti" id="confetti"></div>
        </div>
        <div class="footer" style="text-align:center;">Si la pÃ¡gina no estaba abierta a la hora exacta, verÃ¡s la sorpresa la prÃ³xima vez que entres.</div>
      </section>
    </div>
  </div>

  <script>
    const { DateTime } = luxon;
    const STORAGE_KEY = 'surpriseScheduler_v2'; // Bumped version

    const els = {
      partnerName: document.getElementById('partnerName'),
      partnerTZ: document.getElementById('partnerTZ'),
      revealTime: document.getElementById('revealTime'),
      startDate: document.getElementById('startDate'),
      numDays: document.getElementById('numDays'),
      frequency: document.getElementById('frequency'),
      customWeekdays: document.getElementById('customWeekdays'),
      wdChecks: () => Array.from(document.querySelectorAll('.wd')),
      notes: document.getElementById('notes'),
      generateBtn: document.getElementById('generateBtn'),
      schedBody: document.getElementById('schedBody'),
      todayState: document.getElementById('todayState'),
      countdown: document.getElementById('countdown'),
      noteText: document.getElementById('noteText'),
      revealNowBtn: document.getElementById('revealNowBtn'),
      checkNowBtn: document.getElementById('checkNowBtn'),
      copyBtn: document.getElementById('copyBtn'),
      tzBadge: document.getElementById('tzBadge'),
      tzSub: document.getElementById('subTZ'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importInput: document.getElementById('importInput'),
      clearBtn: document.getElementById('clearBtn'),
      tzList: document.getElementById('tzList'),
      confetti: document.getElementById('confetti'),

      // New Views
      countdownView: document.getElementById('countdown-view'),
      envelopeView: document.getElementById('envelope-view'),
      noteView: document.getElementById('note-view'),
      envelopeWrapper: document.getElementById('envelopeWrapper'),
      envelopeDiv: document.querySelector('.envelope'),
      reactionBtns: document.querySelectorAll('.reaction-btn'),
    };

    // Populate timezone list
    try {
      const zones = Intl.supportedValuesOf?.('timeZone') || [];
      zones.forEach(z => {
        const opt = document.createElement('option');
        opt.value = z; els.tzList.appendChild(opt);
      });
    } catch(_){}

    const save = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    const load = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch { return null; }
    }

    const sampleNotes = `You are my favorite notification.
Te pienso mÃ¡s de lo que digo.
Proud of you today and always.
Our distance is temporaryâ€”our love isnâ€™t.
Coffee soon, same mug different city.
Iâ€™d cross timezones for your smile.
Hoy y siempre: contigo.
You make hard days softer.`;

    function readSettings(){
      const tz = els.partnerTZ.value.trim() || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const [h,m] = (els.revealTime.value || '09:00').split(':').map(x=>parseInt(x,10));
      const start = els.startDate.value ? DateTime.fromISO(els.startDate.value, {zone: tz}).startOf('day') : DateTime.now().setZone(tz).startOf('day');
      const freq = els.frequency.value;
      const weekdays = els.wdChecks().filter(ch=>ch.checked).map(ch=>parseInt(ch.value,10));
      return {
        partnerName: els.partnerName.value.trim() || 'Ella',
        partnerTZ: tz,
        revealHour: h, revealMinute: m,
        startDateISO: start.toISODate(),
        numDays: Math.max(1, Math.min(400, parseInt(els.numDays.value||'30',10))),
        frequency: freq,
        weekdays,
      };
    }

    function readNotes(){
      const raw = (els.notes.value || '').split(/\n/).map(s=>s.trim()).filter(Boolean);
      return raw.length ? raw : sampleNotes.split(/\n/);
    }

    function shuffle(arr){
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function nextDates(settings){
      const { partnerTZ, startDateISO, numDays, frequency, weekdays } = settings;
      let d = DateTime.fromISO(startDateISO, {zone: partnerTZ}).startOf('day');
      const out = [];
      while(out.length < numDays){
        const wd = d.weekday;
        const allow = (frequency === 'daily') ||
                      (frequency === 'weekdays' && wd >=1 && wd <=5) ||
                      (frequency === 'custom' && weekdays.includes(wd));
        if(allow) out.push(d);
        d = d.plus({days:1});
      }
      return out;
    }

    function assignNotesToDates(settings, notes){
      const dates = nextDates(settings);
      const base = notes.map((t, idx)=>({ idx, t }));
      let pool = shuffle(base.slice());
      const entries = [];
      dates.forEach((dt, i)=>{
        if(pool.length === 0) pool = shuffle(base.slice());
        const pick = pool.pop();
        entries.push({ n: i+1, dateISO: dt.toISODate(), noteIndex: pick.idx, revealed:false, revealedAt:null });
      });
      return entries;
    }

    function renderSchedule(settings, notes, schedule){
      els.schedBody.innerHTML = '';
      schedule.forEach((row, i)=>{
        const tr = document.createElement('tr');
        if(row.revealed) tr.classList.add('revealed');
        const date = DateTime.fromISO(row.dateISO, {zone: settings.partnerTZ});
        const time = date.set({hour: settings.revealHour, minute: settings.revealMinute});
        const status = row.revealed ? `<span class="pill-badge success">Revelado</span>` : `<span class="pill-badge scheduled">Programado</span>`;
        tr.innerHTML = `<td>${i+1}</td>
                        <td>${date.toFormat('ccc, LLL d')}</td>
                        <td>${time.toFormat('HH:mm')}</td>
                        <td title="${notes[row.noteIndex]}">${escapeHtml(notes[row.noteIndex]).slice(0,40)}${notes[row.noteIndex].length>40?'â€¦':''}</td>
                        <td>${status}</td>`;
        els.schedBody.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function persist(state){ save(state); }

    function loadIntoUI(){
      const saved = load();
      if(!saved) {
        els.notes.value = sampleNotes;
        els.startDate.value = DateTime.local().toISODate();
        els.partnerTZ.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
        updateTZBadge();
        return;
      }
      const { settings, notes, schedule } = saved;
      els.partnerName.value = settings.partnerName || '';
      els.partnerTZ.value = settings.partnerTZ || '';
      els.revealTime.value = `${String(settings.revealHour).padStart(2,'0')}:${String(settings.revealMinute).padStart(2,'0')}`;
      els.startDate.value = settings.startDateISO || DateTime.local().toISODate();
      els.numDays.value = settings.numDays || 30;
      els.frequency.value = settings.frequency || 'daily';
      if(settings.frequency === 'custom'){
        els.customWeekdays.style.display = '';
        els.wdChecks().forEach(ch => ch.checked = settings.weekdays?.includes(parseInt(ch.value,10)) || false);
      }
      els.notes.value = notes.join('\n');
      renderSchedule(settings, notes, schedule);
      updateTZBadge();
    }

    function deepEqual(a,b){ return JSON.stringify(a)===JSON.stringify(b); }

    function state(){
      const settings = readSettings();
      const notes = readNotes();
      const saved = load();
      // Try to preserve schedule if settings match
      const schedule = saved && deepEqual(saved.settings, settings) && deepEqual(saved.notes, notes)
        ? saved.schedule
        : assignNotesToDates(settings, notes);
      return { settings, notes, schedule };
    }

    // MAIN LOGIC
    function tickCountdown(){
      const s = load(); if(!s) return;
      const now = DateTime.now().setZone(s.settings.partnerTZ);
      const today = now.startOf('day').toISODate();

      // Look for today's entry
      const entry = s.schedule.find(e => e.dateISO === today);

      // If today has an entry:
      if (entry) {
        if (entry.revealed) {
          // Already revealed -> Show note directly (or envelope if we want to reset it on reload? No, keep it simple)
          // Actually, let's just show the note directly if already revealed previously.
          // BUT, to make it cute, maybe we show the open envelope?
          // Let's stick to: if revealed, show Note view.
          showNoteView(entry, s);
        } else {
          // Not revealed yet. Check time.
          const revealTime = now.set({hour:s.settings.revealHour, minute:s.settings.revealMinute, second:0, millisecond:0});
          if (now >= revealTime) {
            // It IS time, but user hasn't opened it yet (revealed flag in JSON is mainly for persistent tracking)
            // Show ENVELOPE.
            showEnvelopeView(entry, s);
          } else {
            // Not time yet -> Countdown
            showCountdownView(s, revealTime);
          }
        }
      } else {
         // No entry for today -> Show countdown to next available date
         showCountdownToNext(s, now);
      }
    }

    // Explicitly transition views
    function switchView(viewName) {
      els.countdownView.style.display = 'none';
      els.envelopeView.style.display = 'none';
      els.noteView.style.display = 'none';

      if(viewName === 'countdown') els.countdownView.style.display = 'flex';
      if(viewName === 'envelope') els.envelopeView.style.display = 'flex';
      if(viewName === 'note') els.noteView.style.display = 'flex';
    }

    function showCountdownView(s, targetTime) {
       switchView('countdown');
       const now = DateTime.now().setZone(s.settings.partnerTZ);
       const diff = targetTime.diff(now, ['hours','minutes','seconds']).toObject();
       els.todayState.textContent = `PrÃ³xima carta para ${s.settings.partnerName} hoy a las ${targetTime.toFormat('HH:mm')}`;
       els.countdown.textContent = `${String(Math.floor(diff.hours||0)).padStart(2,'0')}:${String(Math.floor(diff.minutes||0)).padStart(2,'0')}:${String(Math.floor(diff.seconds||0)).padStart(2,'0')}`;
    }

    function showCountdownToNext(s, now) {
       switchView('countdown');
       // Find next entry in future
       const futureEntries = s.schedule.filter(e => DateTime.fromISO(e.dateISO, {zone:s.settings.partnerTZ}) > now.startOf('day'));
       if(futureEntries.length > 0) {
         const next = futureEntries[0];
         const nextDate = DateTime.fromISO(next.dateISO, {zone:s.settings.partnerTZ});
         els.todayState.textContent = `PrÃ³xima carta: ${nextDate.toFormat('cccc, d LLL')}`;
         els.countdown.textContent = "Pronto...";
       } else {
         els.todayState.textContent = "Â¡Todo completado!";
         els.countdown.textContent = "ðŸŽ‰";
       }
    }

    function showEnvelopeView(entry, s) {
       // If we are already viewing the envelope or note, don't interrupt (unless state changed)
       if (els.noteView.style.display === 'flex') return;
       if (els.envelopeView.style.display === 'flex') return;

       switchView('envelope');

       // Reset envelope state
       els.envelopeDiv.classList.remove('open');

       // Bind click to open
       els.envelopeWrapper.onclick = () => {
         // Animate open
         els.envelopeDiv.classList.add('open');

         // Mark as revealed in storage
         entry.revealed = true;
         entry.revealedAt = DateTime.now().setZone(s.settings.partnerTZ).toISO();
         persist(s);
         renderSchedule(s.settings, s.notes, s.schedule);

         // Fire effects
         fireConfetti();

         // Wait for animation then show note
         setTimeout(() => {
           showNoteView(entry, s);
         }, 800);
       };
    }

    function showNoteView(entry, s) {
      switchView('note');
      els.noteText.textContent = s.notes[entry.noteIndex];
    }

    // Manual override
    function revealNow(){
      const s = load(); if(!s) return alert('Configura primero.');
      const now = DateTime.now().setZone(s.settings.partnerTZ);
      const today = now.startOf('day').toISODate();
      const entry = s.schedule.find(e=>e.dateISO === today) || s.schedule.find(e=>!e.revealed) || s.schedule[0];

      if(entry) {
        showEnvelopeView(entry, s);
        // Auto click for debug? No, let them click.
      }
    }

    function updateTZBadge(){
      const tz = els.partnerTZ.value || Intl.DateTimeFormat().resolvedOptions().timeZone;
      els.tzBadge.textContent = tz; document.getElementById('subTZ').textContent = tz;
    }

    function copyNote(){
      const txt = els.noteText.textContent?.trim();
      navigator.clipboard.writeText(txt).then(()=>{
        const orig = els.copyBtn.textContent;
        els.copyBtn.textContent = 'Â¡Copiado!'; setTimeout(()=>els.copyBtn.textContent=orig, 1200);
      });
    }

    // Reaction Buttons
    els.reactionBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
         const emoji = btn.getAttribute('data-emoji');
         fireEmoji(emoji);
      });
    });

    function fireEmoji(emoji) {
      const cont = els.confetti;
      for(let i=0; i<15; i++) {
        const p = document.createElement('div');
        p.textContent = emoji;
        p.style.position = 'absolute';
        p.style.left = (50 + (Math.random()*20 - 10)) + '%';
        p.style.top = '50%';
        p.style.fontSize = (20 + Math.random()*20) + 'px';
        p.style.pointerEvents = 'none';
        p.style.animation = `floatEmoji 1s ease-out forwards`;
        // Random trajectory
        const tx = (Math.random()*200 - 100) + 'px';
        const ty = (Math.random()*200 - 100) + 'px';
        p.style.setProperty('--tx', tx);
        p.style.setProperty('--ty', ty);

        cont.appendChild(p);
        setTimeout(()=>p.remove(), 1000);
      }

      // Add a style rule for this animation if not exists
      if(!document.getElementById('emoji-style')) {
        const style = document.createElement('style');
        style.id = 'emoji-style';
        style.textContent = `
          @keyframes floatEmoji {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1.5); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
    }

    function fireConfetti(){
      const cont = els.confetti; cont.innerHTML = '';
      const colors = ['#60a5fa','#34d399','#f472b6','#fbbf24','#a78bfa'];
      for(let i=0;i<100;i++){
        const p = document.createElement('div'); p.className='p';
        p.style.left = Math.random()*100 + 'vw';
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.animationDuration = (2 + Math.random()*3) + 's';
        cont.appendChild(p);
      }
      setTimeout(()=>{ cont.innerHTML=''; }, 5000);
    }

    function resetAll(){
      if(!confirm('Â¿Seguro que quieres borrar todo?')) return;
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }

    async function autoLoadScheduleFromJSON(){
      const existing = load(); if (existing) return;
      try {
        const res = await fetch('schedule.json?v=' + Date.now());
        if (!res.ok) return;
        const obj = await res.json();
        save(obj); loadIntoUI();
      } catch (_) { }
    }

    function exportJSON(){
      const s = load() || state();
      const blob = new Blob([JSON.stringify(s, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sorpresas.json';
      a.click();
    }

    function importJSON(file){
      const r = new FileReader();
      r.onload = e => {
        try { save(JSON.parse(e.target.result)); loadIntoUI(); tickCountdown(); } catch(err){ alert('Error'); }
      };
      r.readAsText(file);
    }

    // Events
    els.generateBtn.addEventListener('click', ()=>{ const s = state(); renderSchedule(s.settings, s.notes, s.schedule); persist(s); tickCountdown(); alert('Â¡Listo!'); });
    els.revealNowBtn.addEventListener('click', revealNow);
    els.checkNowBtn.addEventListener('click', tickCountdown);
    els.copyBtn.addEventListener('click', copyNote);
    els.exportBtn.addEventListener('click', exportJSON);
    els.importBtn.addEventListener('click', ()=> els.importInput.click());
    els.importInput.addEventListener('change', (e)=>importJSON(e.target.files[0]));
    els.clearBtn.addEventListener('click', resetAll);
    els.partnerTZ.addEventListener('input', updateTZBadge);
    els.frequency.addEventListener('change', ()=>{ els.customWeekdays.style.display = els.frequency.value==='custom' ? '' : 'none'; });

    // Init
    loadIntoUI();
    updateTZBadge();
    (async () => {
       await autoLoadScheduleFromJSON();
       if(!load()){ save(state()); renderSchedule(state().settings, state().notes, state().schedule); }

       (function loop(){ tickCountdown(); setTimeout(loop, 1000); })();
    })();

  </script>
</body>
</html>